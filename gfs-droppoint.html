﻿<link rel="import" href="../polymer/polymer.html" />

<!--
    `gfs-droppoint`
    A polymer widget for displaying droppoints

    @demo demo/index.html
-->

<dom-module id="gfs-droppoint">

    <template>
        <style>
            div, span, h3, ul, tr {
                font-family: "Raleway", "Helvetica Neue", Verdana, Arial, sans-serif;
            }

            h3 {
                margin-top: 0px;
            }

            ul {
                margin: 0;
                padding: 0;
            }

            li {
                display: block;
            }

            tr {
                line-height: 0.6em;
            }

            .content-container {
                margin: auto;
            }

            .overlay {
                margin: auto;
                width: 100%;
            }

                .overlay .special-badges {
                    float: none;
                }

            .no-button button {
                display: none;
            }

            .no-button.dp-card .actions {
                display: none;
            }

            .no-button.dp-card {
            }

            .dp-card {
                padding: 10px;
                margin: 10px;
                background-color: #fff;
                border-radius: 3px;
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                border: 1px solid #FAFAFA;
            }

                .dp-card .content {
                    display: flex;
                }

            .dp-heading {
                margin-top: 4px;
                margin-bottom: 4px;
            }

            .dp-small-heading {
                margin-top: 0;
                margin-bottom: 0;
                font-size: 0.6em;
                text-align: left;
            }

            .label {
                color: white;
                font-weight: bold;
            }

            .dp-content {
                width: 100%;
            }

            .dp-address {
                text-align: left;
            }

            #dp-distance {
                margin-bottom: 0px;
            }

                #dp-distance .fa {
                    margin-right: 0.2em;
                }

            .choose-droppoint {
                background-color: #555555;
                border: none;
                color: white;
                margin-top: 3px;
                padding: 8px 20px;
                text-align: center;
                text-decoration: none;
                font-size: 16px;
                cursor: pointer;
                position: absolute;
                right: 15px;
                bottom: 10px;
                transition: opacity 300ms ease-in-out;
            }

                .choose-droppoint:hover {
                    opacity: .85;
                }

                .choose-droppoint.chosen, .choose-droppoint.unchose {
                    background-color: #4caf50;
                }

                    .choose-droppoint.chosen:hover {
                        opacity: .8;
                    }

                    .choose-droppoint.unchose:hover {
                        opacity: .8;
                    }

            .dp-opening-hours {
                width: 45%;
                margin-top: 6px;
                text-align: right;
            }

            .overlay #dp-address,
            .overlay .dp-small-heading,
            .overlay #dp-distance {
                display: none;
            }

                .overlay .dp-small-heading.opening-hours {
                    display: block;
                }

            .overlay .dp-small-heading {
                margin-top: 5px;
                text-align: left;
            }

            .overlay .dp-opening-hours {
                width: 100%;
                margin-top: 20px;
                padding: 5px 15px 15px;
            }

            .dp-card {
                width: 336px;
                height: 340px;
                margin: 10px 20px 10px 0;
                position: relative;
            }

                .dp-card:nth-child(2n+1) {
                    margin-right: 0;
                }

                .dp-card .content .dp-details {
                    width: 51%;
                    margin: 0 10px 0 0;
                    padding: 5px 15px 15px;
                    font-size: 13px;
                    overflow: hidden;
                }

            /* opening hours style */
            .dp-day-time-slots {
                width: 75%;
                font-size: 13px;
                line-height: 10px;
                display: inline-block;
            }

            .dp-day-time-slot:nth-child(2n) {
                margin: 5px 0;
                position: relative;
            }

            li.dp-day-time-slot {
                text-align: right;
            }

            .dp-day-name {
                width: 20%;
                font-size: 13px;
                font-weight: bold;
                margin-top: 1px;
                vertical-align: top;
                display: inline-block;
            }

            .dp-small-heading {
                margin-bottom: 0;
                font-size: 13px;
                font-weight: bold;
            }

                .dp-small-heading.opening-hours {
                    margin: 0 0 5px;
                }

                .dp-small-heading .fa-clock-o, .dp-small-heading .fa-road {
                    font-size: 15px;
                }

            .weekCollection {
                margin: 10px 0 0;
            }

            .wrap-opening-hours {
                margin: 4px 0 0 0;
                min-height: 20px;
                height: auto;
                text-align: left;
            }

            .multi-times {
                line-height: 20px;
            }

            .dp-icon {
                background: #fff;
                margin: 0 0 5px;
            }

            ::content .dp-icon {
                padding: 10px 0 10px 10px;
            }

            .dp-address, .dp-distance {
                font-size: 13px;
            }

            /* clear floats */
            .clear-fl {
                clear: both;
            }

            .overlay {
                font-size: 13px;
            }

                .overlay .dp-day-time-slots {
                    width: auto;
                }

            #dp-address {
                max-width: 200px;
            }

                #dp-address .store-name {
                    margin: 0 0 3px;
                    font-weight: bold;
                    text-transform: capitalize;
                }

            @media (max-width: 1024px) {
                .dp-card {
                    width: 330px;
                    margin: 10px 0;
                    display: block;
                }
            }

            @media (max-width: 976px) {

                .dp-card .content {
                    display: block;
                }

                .dp-details {
                    float: left;
                    width: 100%;
                }

                .dp-opening-hours {
                    float: left;
                }

                .dp-card-margin {
                    margin-right: 20px;
                }

                .actions {
                    clear: both;
                }
            }

            @media (max-width: 736px) and (orientation: landscape) {

                .dp-card {
                    width: 322px;
                    height: 330px;
                }

                    .dp-card .content .dp-details {
                        width: 41%;
                        font-size: 12px;
                    }

                .dp-opening-hours {
                    min-width: 55%;
                    width: auto;
                    float: right;
                }

                .dp-day-time-slots {
                    width: 65%;
                }

                #dp-address {
                    font-size: 12px;
                }
            }

            @media (max-width: 667px) {
                .dp-card {
                    min-width: 285px;
                    width: 285px;
                    max-width: 345px;
                    height: 330px;
                }

                    .dp-card .content .dp-details {
                        width: 44%;
                        padding: 0;
                    }

                #dp-address {
                    margin: 0 0 10px;
                }

                .dp-opening-hours {
                    min-width: 52%;
                }

                .dp-day-name {
                    width: 28%;
                    font-size: 12px;
                }

                .dp-day-time-slots {
                    width: initial;
                    font-size: 12px;
                }
            }

            @media (max-width: 568px) {
                .dp-card {
                    min-width: 280px;
                    width: 280px;
                    max-width: 345px;
                    height: 335px;
                }

                    .dp-card .content .dp-details {
                        width: 41%;
                    }

                .dp-opening-hours {
                    min-width: 55%;
                }
            }

            @media (max-width: 414px) {
                .dp-card {
                    min-width: 343px;
                    max-width: 100%;
                    height: 335px;
                }

                    .dp-card:nth-child(2n+1) {
                        margin-right: 0;
                    }

                    .dp-card .content .dp-details {
                        min-width: initial !important;
                        font-size: 13px;
                    }

                .dp-opening-hours {
                    width: 52%;
                }

                .dp-small-heading {
                    font-size: 13px;
                }
            }

            @media (max-width: 375px) {
                .dp-card {
                    min-width: 303px;
                    min-height: 335px;
                    height: auto;
                }

                    .dp-card .content .dp-details {
                        width: 46%;
                        font-size: 12px;
                    }

                .dp-opening-hours {
                    width: 50%;
                    min-width: initial !important;
                }
            }

            @media (max-width: 340px) {

                .dp-card {
                    min-width: 249px;
                    width: 249px;
                    margin: 10px 0;
                    padding: 0;
                    display: block;
                }

                    .dp-card .content .dp-details {
                        width: 45%;
                        font-size: 11px;
                        margin: 0 5px 0 0;
                        padding: 5px 10px 15px 10px;
                    }

                .dp-small-heading {
                    font-size: 12px;
                }

                    .dp-small-heading i {
                        font-size: 13px;
                    }

                .dp-opening-hours {
                    width: 52%;
                    min-width: initial !important;
                }

                .dp-day-name {
                    width: 20%;
                }

                .dp-day-name, .dp-day-time-slots {
                    font-size: 11px;
                }
            }
        </style>

        <div class$="{{containerClass}}">
            <template is="dom-if" if="{{title}}">
                <h3>{{title}}</h3>
            </template>

            <div class="content">
                <div class="dp-details">
                    <div class="dp-icon">
                        <img src="{{_icon}}" width="95" />
                    </div>
                    <div id="dp-address">
                        <div class="store-name">
                            {{droppointDescription}}
                        </div>
                        <template is="dom-repeat" items="{{droppointData.geoLocation.addressLines}}">
                            <div class="store-address">
                                {{item}},
                            </div>
                        </template>

                        <div class="store-location">
                            {{droppointData.geoLocation.town}}, {{droppointData.geoLocation.postCode}}
                        </div>
                    </div>
                    <template is="dom-if" if="showDistance">
                        <div class="dp-small-heading">
                            <i class="fa fa-road"></i> Distance
                        </div>
                        <div id="dp-distance">
                            {{droppointData.localizedDistance}}
                        </div>
                    </template>
                </div>

                <template is="dom-if" if="{{showOpeningHours}}">
                    <div class="dp-opening-hours">
                        <div class="dp-small-heading opening-hours">
                            <i class="fa fa-clock-o"></i> Opening Hours
                        </div>
                        <div class="weekCollection">
                            <template is="dom-repeat" items="{{_weekCollection}}">
                                <div class="wrap-opening-hours">
                                    <div class="dp-day-name">
                                        <ul>
                                            <li>{{item.day}}</li>
                                        </ul>
                                    </div>
                                    <div class="dp-day-time-slots">
                                        <ul>
                                            <template is="dom-repeat" items={{item.timeSlots}}>
                                                <li class="dp-day-time-slot">{{item.fromTime}} - {{item.toTime}}</li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            <div class="actions">
                <template is="dom-if" if="{{isStandardButton}}">
                    <div on-tap="toggleChooseDropPoint" class$="button choose-droppoint {{buttonClass}}">
                        {{displayButtonText}}
                    </div>
                </template>
            </div>
        </div>

    </template>

    <script>

        Polymer({
            is: "gfs-droppoint",

            properties: {
                title: {
                    type: String
                },

                droppointData: {
                    type: Object,
                    value: {}
                },
                buttonType: {
                    type: String,
                    value: "standard"
                },
                showOpeningHours: {
                    type: Object,
                    value: false
                },
                showDistance: {
                    type: Object,
                    value: true
                },
                containerClass: {
                    type: String,
                    value: "content-container"
                },
                droppointId: {
                    type: String
                },
                buttonClass: {
                    type: String,
                    value: "Deselect"
                },
                buttonSelectedText: {
                    type: String,
                    value: "Select"
                },
                buttonDeselectedText: {
                    type: String,
                    value: "Deselect"
                },
                streetAddress: {
                    type: String,
                    notify: true
                },
                providerLogo: {
                    type: String
                },
                providerName: {
                    type: String
                },
                _icon: {
                    type: String,
                    computed: "_computeIcon(providerLogo, providerName)"
                },
                _weekCollection: {
                    type: Object,
                    notify: true
                },
            },


            ready: function () {
                this.displayButtonText = this.buttonSelectedText;
                this.initData();
                if (this.buttonType === "none") {
                    this.isTickButton = false;
                    this.isStandardButton = false;
                }
                else {
                    this.isTickButton = (this.buttonType === "tick");
                    this.isStandardButton = !this.isTickButton;
                }

                window.addEventListener('droppoint-changed', this.onDroppointChanged.bind(this), false);
            },

            initData: function () {
                this.droppointId = this.droppointData.droppointId || "";
                if (typeof (this.droppointData.chosen) === "undefined") {
                    this.droppointChosen = false;
                }
                if (this.droppointData.collectionSlots) {
                    this.droppointData.distanceInKm = (Math.round(this.droppointData.DistanceInMeters / 100)) / 10;

                    var dayCount = 0;
                    var self = this;
                    var buildWeekCollection = [];

                    self.providerName = this.droppointData.providerName;
                    self.providerLogo = this.droppointData.geoLocation.countryCode;

                    this.droppointData.weekCollectionSlots = [];
                    if (!this.droppointData.collectionSlots) this.droppointData.collectionSlots = [];

                    this.droppointData.collectionSlots.forEach(function (collectionSlot) {
                        dayCount++;
                        if (dayCount <= 7) {

                            collectionSlot.collectionDateTime = self._getUtcTime(new Date(collectionSlot.collectionDate));
                            collectionSlot.day = DOW_NAMES[collectionSlot.collectionDateTime.getDay()];

                            collectionSlot.timeSlots.forEach(function (timeSlot) {
                                timeSlot.fromTime = timeSlot.from;
                                timeSlot.toTime = timeSlot.to;
                            });

                            if (collectionSlot.timeSlots.length > 0) {
                                buildWeekCollection.push(collectionSlot);
                            }
                        }
                    });
                    this.set('_weekCollection', buildWeekCollection);
                    this.streetAddress = this.droppointData.geoLocation.addressLines[0] + ", " + this.droppointData.geoLocation.town + ", " + this.droppointData.geoLocation.postCode;
                }

                if ((Object.keys(this.droppointData).length) > 0) {
                    this.droppointDescription = this.droppointData.droppointDescription.toLowerCase();
                    this.droppointData.droppointDescription = this.droppointData.droppointDescription.toLowerCase(); // selected droppoint
                }
            },


            //Global event handler
            onDroppointChanged: function (e) {
                this.render();
            },

            //Local event fired
            chosenChanged: function (e) {
                if (typeof (this.droppointData.chosen) === "null") return;
                //Send global event
                this.fire("droppoint-changed", this.droppointData);

                // clear selected service when you change or deselect a drop point
                var droppointItems = document.getElementsByClassName("droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }
                this.fire("getDroppointSelectedService");
            },

            render: function () {
                this.initData();
                if (this.droppointData.chosen) {
                    this.buttonClass = "chosen";
                    this.displayButtonText = this.buttonDeselectedText;
                }
                else {
                    this.buttonClass = "unchosen";
                    this.displayButtonText = this.buttonSelectedText;
                    
                }
            },

            toggleChooseDropPoint: function () {
                this.set("droppointData.chosen", !this.droppointData.chosen);
                this.chosenChanged();
            },

            _getUtcTime: function (d) {
                var utc = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), d.getUTCHours(), d.getUTCMinutes(), d.getUTCSeconds());
                return utc;
            },

            _getTimeStr: function (d) {
                var minutes = d.getMinutes().toString().length == 1 ? '0' + d.getMinutes() : d.getMinutes();
                var hours = d.getHours() > 12 ? (d.getHours() % 12).toString() : d.getHours().toString();
                var ampm = d.getHours() >= 12 ? 'pm' : 'am';
                return hours + ':' + minutes + ampm;
            },

            _listenForChoose: function (e) {

            },

            _computeIcon: function(countryCode, providerName) {
                var url = this.resolveUrl('/bower_components/gfs-droppoint/images/carriers');

                if (providerName === 'DPD') {
                    this.providerName = 'dpdpickup'
                }

                switch(countryCode) {
                    case "DE":
                        return url + '/DE/' + this.providerName + '.png';
                    case "FR":
                    case "BE":
                    case "ES":
                        return url + '/FR/' + this.providerName + '.png';
                    default:
                        return url + '/GB/' + this.providerName + '.png';
                }
            }
        });
    </script>
</dom-module>
