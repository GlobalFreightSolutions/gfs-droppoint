<link rel="import" href="../polymer/polymer.html"/>

<dom-module id="gfs-droppoint">

	<template>
		<style>
			div, span, h3, ul, tr {
				font-family: "Raleway", "Helvetica Neue", Verdana, Arial, sans-serif;
			}

			h3 {
				margin-top: 0px;
			}

			ul {
				padding-left: 2px;
			}

			li {
				display: block;
			}

			tr {
				line-height: 0.6em;
			}

			.content-container {
				margin: auto;
				/*width: 100%;*/
			}

			.overlay {
				margin: auto;
				width: 100%;
			}

				.overlay .special-badges {
					float: none;
				}

			.content-container-cols {
				display: flex;
				margin: auto;
				width: 100%;
			}

			.no-button button {
				display: none;
			}

			.no-button.dp-card .actions {
				display: none;
			}

			.no-button.dp-card {
				/*height: 208px;*/
			}

			.dp-card {
				padding: 10px;
				margin: 10px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
			}

			.dp-mini-card {
				padding: 10px;
				margin: 10px;
				width: 200px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
			}


			.dp-card .content {
				display: flex;
			}

				.dp-card .content .dp-details {
					width: 66%;
					overflow: hidden;
				}

			.dp-heading {
				margin-top: 4px;
				margin-bottom: 4px;
			}

			.dp-small-heading {
				margin-top: 0;
				margin-bottom: 0;
				font-size: 0.6em;
			}

			.label {
				color: white;
				font-weight: bold;
			}

			.dp-content {
				width: 100%;
			}

			.dp-address {
				text-align: left;
			}

			.open-late {
				font-size: 0.5em;
				padding: 4px;
			}

			#dp-distance {
				margin-bottom: 0px;
			}

				#dp-distance .fa {
					margin-right: 0.2em;
				}

			.choose-droppoint {
				background-color: #555555;
				border: none;
				color: white;
				margin-top: 3px;
				padding: 8px 20px;
				text-align: center;
				text-decoration: none;
				font-size: 16px;
				float: right;
				cursor: pointer;
				transition: opacity 300ms ease-in-out 
			}

				.choose-droppoint:hover {
					opacity: .85;
				}

				.choose-droppoint.chosen {
					background-color: #4CAF50; /* Green */
				}

					.choose-droppoint.chosen:hover {
						opacity: 1;
					}

				.choose-droppoint.unchose {
					background-color: #d60000; /* Green */
				}

					.choose-droppoint.unchose:hover {
						opacity: 1;
					}

			.dp-opening-hours table {
				margin-top: 6px;
			}

			div.dp-day-name {
				font-weight: bold;
			}

			.b-cancel {
			}

			.b-tick {
				display: block;
				height: 32px;
				width: 32px;
			}

				.b-tick.unchosen {
					background-image: url('/bower_components/gfs-droppoint/images/tick.png');
					background-position: -6px 0;
					background-repeat: no-repeat;
				}

				.b-tick.chosen {
					background-image: url('/bower_components/gfs-droppoint/images/tick_on.png');
					background-position: -6px 0;
					background-repeat: no-repeat;
				}

			.special-badges {
				margin: 5px 0 0;
				display: flex;
				float: right;
			}

			.open-late {
				background-image: url('/bower_components/gfs-droppoint/images/opensign.png');
				background-repeat: no-repeat;
				background-size: 26px 26px;
				width: 32px;
			}

			.parking {
				background-image: url('/bower_components/gfs-droppoint/images/parking.png');
				background-repeat: no-repeat;
				background-size: 32px 32px;
				width: 32px;
			}

			.open-late .badge-text {
				margin-top: 22px;
				font-weight: bold;
			}

			.overlay .open-late {
				-webkit-filter: invert(1);
				filter: invert(1);
			}


			/* MP customization */
			.dp-card {
				width: 336px;
				height: 340px;
				margin: 10px 20px 10px 0;
			}

				.dp-card:nth-child(2n+1) {
					margin-right: 0;
				}

				.dp-card .content .dp-details {
					width: 43%;
					margin: 0 10px 0 0;
				}

			/* opening hours table style */
			td.dp-day-time-slots {
				line-height: 10px;
			}

			.dp-day-name, .dp-day-time-slot {
				font-size: 13px;
			}

				.dp-day-time-slot:nth-child(2n) {
					margin: 5px 0;
					position: relative
				}

			.dp-small-heading {
				margin-bottom: 0;
				font-size: 13px;
				font-weight: bold;
			}

				.dp-small-heading .fa-clock-o, .dp-small-heading .fa-road {
					font-size: 15px
				}

			.multi-times {
				line-height: 20px
			}

			.dp-icon {
				margin: 0 0 5px;
			}

			.dp-address, .dp-distance {
				font-size: 13px;
			}

			/* clear floats */
			.clear-fl {
				clear: both;
			}

			.overlay {
				font-size: 13px;
			}

			#dp-address {
				max-width: 200px;
			}

			#dp-address .store-name {
				margin: 0 0 3px;
				font-weight: bold;
				text-transform: capitalize
			}

			@media (max-width: 976px) {
				.dp-card {
					min-width: 330px;
					width: 100%;
					margin: 10px 0;
					display: block;
				}

					.dp-card .content {
						display: block;
					}

				.dp-details {
					float: left;
				}

				.dp-opening-hours {
					float: left;
				}

				.dp-card-margin {
					margin-right: 20px;
				}

				.dp-card .content .dp-details {
					width: 120px;
				}

				.actions {
					clear: both;
				}
			}

			@media (max-width: 667px) {
				.dp-card {
					min-width: 286px;
					max-width: 286px;
				}

				.dp-card .content .dp-details {
					width: 95px;
				}
			}

			@media (max-width: 375px) {
				.dp-card {
					min-width: 305px;
				}
			}

			@media (max-width: 340px) {
				.dp-card {
					min-width: 250px;
					margin: 10px 0;
					display: block;
				}

				.dp-details {
					float: left;
				}

				.dp-opening-hours {
					float: left;
				}

				.dp-card-margin {
					margin-right: 10px;
				}

				.dp-card .content .dp-details {
					width: 80px;
					/*margin-right: 18px;*/
				}

				#dp-address, #dp-distance, .dp-small-heading,
				.dp-day-name, .dp-day-time-slot {
					font-size: 11px;
				}
			}
		</style>


		<div class$="{{containerClass}}">
			<template is="dom-if" if="{{title}}">
				<h3>{{title}}</h3>
			</template>

			<div class="content">

				<div class="dp-details">

					<div class="dp-icon">
						<img src="/bower_components/gfs-droppoint/images/carriers/medium/{{droppointData.providerName}}.png" width="95" />
					</div>
					<div id="dp-address">
						<div class="store-name">
							{{droppointDescription}}
						</div>
						<template is="dom-repeat" items="{{droppointData.geoLocation.addressLines}}">
							<div class="store-address">
								{{item}},
							</div>
						</template>
						
						<div class="store-location">
							{{droppointData.geoLocation.town}}, {{droppointData.geoLocation.postCode}}
						</div>
					</div>
					<template is="dom-if" if="showDistance">
						<div class="dp-small-heading">
							<i class="fa fa-road"></i> Distance
						</div>
						<div id="dp-distance">
							{{droppointData.localizedDistance}}
						</div>
					</template>

				</div>


				<template is="dom-if" if="{{showOpeningHours}}">

					<div class="dp-opening-hours">
						<div class="dp-small-heading">
							<i class="fa fa-clock-o"></i> Opening Hours
						</div>
						<table>
							<template is="dom-repeat" items="{{_weekCollection}}">
								<tr>
									<td class="dp-day-name">
										<ul>
											<li>{{item.day}}</li>
										</ul>
									</td>
									<td class="dp-day-time-slots">
										<ul class="testMe">
											<template is="dom-repeat" items={{item.timeSlots}}>
												<li class="dp-day-time-slot">{{item.fromTime}} - {{item.toTime}}</li>
											</template>
										</ul>
									</td>
								</tr>
							</template>
						</table>

						<!--<div class="special-badges">
							<div class="open-late">
								<div class="badge-text">LATE</div>
							</div>
							<div class="open-late">
								<div class="badge-text">SAT</div>
							</div>
							<div class="open-late">
								<div class="badge-text">SUN</div>
							</div>
							<div class="parking"></div>
						</div>-->
					</div>
				</template>
			</div>
			<div class="actions">
				<!--<template is="dom-if" if="{{isTickButton}}">
					<div class$="b-tick {{buttonClass}}" on-click="toggleChooseDropPoint"></div>
				</template>-->
				<template is="dom-if" if="{{isStandardButton}}">
					<div on-tap="toggleChooseDropPoint" on-mouseover="onHovered" on-mouseout="onUnHovered" class$="button choose-droppoint {{buttonClass}}">{{buttonText}}</div>
				</template>
			</div>
		</div>

	</template>

	<script>

		Polymer({
			is: "gfs-droppoint",

			properties: {
				title: {
					type: String
				},

				droppointData: {
					type: Object,
					value: {}
				},
				buttonType: {
					type: String,
					value: "standard"
				},
				showOpeningHours: {
					type: Object,
					value: false
				},
				showDistance: {
					type: Object,
					value: true
				},
				containerClass: {
					type: String,
					value: "content-container"
				},
				/*chosen: {
                    type: Boolean,
                    value: false,
                    notify: true
                },*/
				droppointId: {
					type: String
				},
				buttonClass: {
					type: String,
					value: "unchosen"
				},
				buttonText: {
					type: String,
					value: "Choose"
				},
				streetAddress: {
					type: String,
					notify: true
				},
				_weekCollection: {
				    type: Object,
				    notify: true
				}
			},


			ready: function () {

				var self = this;
				this.initData();
				if (this.buttonType === "none")
				{
					this.isTickButton = false;
					this.isStandardButton = false;					
				} else {
					this.isTickButton = (this.buttonType === "tick");
					this.isStandardButton = !this.isTickButton;
				}

				// window.addEventListener('droppointChosen', this.onDroppointChosen.bind(this), false);
				// window.addEventListener('droppointUnchosen', this.onDroppointUnchosen.bind(this), false);
				window.addEventListener('droppoint-changed', this.onDroppointChanged.bind(this), false);
			},

			initData: function () {
				//this.chosen = this.droppointData.chosen;
				this.droppointId = this.droppointData.droppointId || "";
				if (typeof (this.droppointData.chosen) === "undefined") {
					this.droppointChosen = false;
				}
				if (this.droppointData.collectionSlots) { // && this.droppointData.collectionSlots) {
					this.droppointData.distanceInKm = (Math.round(this.droppointData.DistanceInMeters / 100)) / 10;

					var dayCount = 0;
					var self = this;
					var buildWeekCollection = [];
					this.droppointData.weekCollectionSlots = [];
					if (!this.droppointData.collectionSlots) this.droppointData.collectionSlots = [];

					this.droppointData.collectionSlots.forEach(function (collectionSlot) {
						dayCount++;
						if (dayCount <= 7) {

							collectionSlot.collectionDateTime = self._getUtcTime(new Date(collectionSlot.collectionDate));
							collectionSlot.day = DOW_NAMES[collectionSlot.collectionDateTime.getDay()];

							collectionSlot.timeSlots.forEach(function (timeSlot) {
								timeSlot.fromDateTime = self._getUtcTime(new Date(timeSlot.from));
								timeSlot.toDateTime = self._getUtcTime(new Date(timeSlot.to));
								timeSlot.fromTime = self._getTimeStr(timeSlot.fromDateTime);
								timeSlot.toTime = self._getTimeStr(timeSlot.toDateTime);
							});
								
							if (collectionSlot.timeSlots.length > 0) {
							    //self.droppointData.weekCollectionSlots.push(collectionSlot);
							    buildWeekCollection.push(collectionSlot);
							}
						}
					});
					this.set('_weekCollection', buildWeekCollection);
					this.streetAddress = this.droppointData.geoLocation.addressLines[0] + ", " + this.droppointData.geoLocation.town + ", " + this.droppointData.geoLocation.postCode;
				}
			
				if ((Object.keys(this.droppointData).length) > 0) {
					this.droppointDescription = this.droppointData.droppointDescription.toLowerCase();
					this.droppointData.droppointDescription = this.droppointData.droppointDescription.toLowerCase(); // selected droppoint
				}
			},


			//Global event handler
			onDroppointChanged: function (e) {
				this.render();
			},

			//Local event fired
			chosenChanged: function (e) {
				if (typeof (this.droppointData.chosen) === "null") return;
				//Send global event
				this.fire("droppoint-changed", this.droppointData);

				// clear selected service when you change or deselect a drop point
				var droppointItems = document.getElementsByClassName("droppoint-delivery-selection");
				for (var i = 0; i < droppointItems.length; i++) {
					droppointItems[i].checked = false;
				}
				this.fire("getDroppointSelectedService");
			},

			render: function () {
				this.initData();
				if (this.droppointData.chosen) {
					this.buttonClass = "chosen";
					this.buttonText = "Chosen";
				}
				else {
					this.buttonClass = "unchosen";
					this.buttonText = "Choose";
				}
			},

			onHovered: function () {
				if (typeof (this.droppointData.chosen) === "undefined") {
					this.droppointChosen = false;
					this.buttonClass = "unchosen";
					this.buttonText = "Choose";
				}
				else if (this.droppointData.chosen === false) {
					this.buttonClass = "unchosen";
					this.buttonText = "Choose";
				}
				else {
					this.buttonClass = "unchose";
					this.buttonText = "Unchose";
				}
			},

			onUnHovered: function() {
				if (typeof (this.droppointData.chosen) === "undefined") {
					this.droppointChosen = false;
					this.buttonClass = "unchosen";
					this.buttonText = "Choose";
				}
				else if (this.droppointData.chosen === true) {
					this.buttonClass = "chosen";
					this.buttonText = "Chosen";
				}
				else if (this.droppointData.chosen === false) {
					this.buttonClass = "unchosen";
					this.buttonText = "Choose";
				}
			},

			toggleChooseDropPoint: function () {
				this.set("droppointData.chosen", !this.droppointData.chosen);
				this.chosenChanged();
			},

			_getUtcTime: function (d) {
				var utc = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), d.getUTCHours(), d.getUTCMinutes(), d.getUTCSeconds());
				return utc;
			},

			_getTimeStr: function (d) {
				var minutes = d.getMinutes().toString().length == 1 ? '0' + d.getMinutes() : d.getMinutes();
				var hours = d.getHours() > 12 ? (d.getHours() % 12).toString() : d.getHours().toString();
				var ampm = d.getHours() >= 12 ? 'pm' : 'am';
				return hours + ':' + minutes + ampm;
			},

			_listenForChoose: function (e) {

			}

		});
	</script>
</dom-module>
